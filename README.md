# Hliðskjálf
`hliðskjálf` is a program to parallelize computations in [Magma](http://magma.maths.usyd.edu.au/magma/). It is aimed at *embarrassingly parallel* problems where the tasks require uneven running time or memory. It employs an adaptive scheme to establish task running order, for an efficient use of memory and CPU time.

The user must provide

- a *work script*, namely a Magma script that performs the actual computational work. The work script takes a list of computations to be performed as an input and prints out the corresponding results (more precisely, it prints out a CSV file where each row contains both the input and the output for a specific computation).
- a *computations file*, namely a CSV file whose rows represent computations to be performed.
- a *schema file*, which defines the format of both the work script output and the computations file.

## Compiling, installing and testing

`hliðskjálf` requires [CMake](https://cmake.org), `ncurses` and the [Boost libraries](https://www.boost.org) to compile; it requires [Magma](http://magma.maths.usyd.edu.au/magma/) to run. `hliðskjálf` has been tested on CentOS Linux 7, using gcc 8.3.1, boost 1.71, cmake 3.24.2 and Magma 2.24-5.

To compile, run

	mkdir build
	cd build
	cmake ..
	cmake --build .
	
This creates two executables in the `build` directory.

To install, run 

	cd build
	cmake --install . --prefix=the/path/I/choose

This installs the executables `yggdrasill` and `hliðskjálf` to the path of your choice.

To test that everything works, run
	
	cd build
	ctest --test-dir test
	
The directory *example* contains an example which can be run using
	
	example/sh/run.sh

## Running `hliðskjálf`

`hliðskjálf` shall be run as 

	`hliðskjálf` --script workscript.m --schema schemafile.info --computations computationsfile.comp

This command instructs `hliðskjálf` to run the work script `workscript.m` over the computations contained in the computations file `computationsfile.comp`. The format of the computations file is explained below.

### Computations and schema file

Each row in the computations file takes the form 

	a_1;a_2;...;a_n

Exactly one of the fields `a_i` is interpreted as the `primary input`; the field must be of integer type. The other fields may be either `secondary input` or ignored. The schema file `schemafile.info` is used to determine how the fields `a_i` should be interpreted. The schema file shall contain a section of the form 

	inputcolumns <primary> {
		[textinputcolumn|rangeinputcolumn <columnnumber>]
		...		
	}

where `primary` indicates the index of the colum containing the `primary input`. Each row inside the curly braces instruct `hliðskjálf` to interpret the column with index `columnnumber` as a secondary input column of type *text* or *range*. 

For instance,

	inputcolumns 4 {
		textinputcolumn 3
		textinputcolumn 2
	}

indicates that the field `a_4` in each row of the computations file should be interpreted as primary input.

	a_4;a_3;a_2

In practice, it is typically simpler to respect the order in the definition, so the above could be rewritten as 

inputcolumns 1 {
	textinputcolumn 2
	textinputcolumn 3
}

This will make the computations be passed into the work script as 

	a_1;a_2;a_3

If a secondary input column is indicates as a *range* in the schema, the corresponding field `a_i` in the computations file must take the form `m..n`, where `m` and `n` are integers. This will have the effect of invoking the work script by passing every value in the closed integer range [m..n] as the `i`-th parameter.

For instance, the schema

	inputcolumns 1 {
		rangeinputcolumn 2
		textinputcolumn 3
	}

declares that rows in the computation files will take the form 

	d;a..b;TEXT. 

Here, d,a,b are integers, and TEXT is an arbitrary string. This line is interpreted as a list of computations to be passed to the work script, namely

	d;a;TEXT
		.
		.
		.
	d;b;TEXT


### Work script

The work script is a Magma program that accepts the following parameters:

* printVersion. If set, then the script only prints a string identifying the script version and quits;
* dataFile. Path of a file containing the list of computations to be performed.
* megabytes. Memory limit in MB. The script should honour this limit by invoking 

		SetMemoryLimit(StringToInteger(megabytes)*1024*1024)

The `dataFile` is a CSV generated by `hliðskjálf`, containing the list of computatations (`;` is used as a separator). The first entry in the row is the primary input; the others are the secondary inputs (in the order specified in the schema definition).
The work script should `load` the file included in `magma/`hliðskjálf`layer.m` and use the function `WriteFields` defined therein to print each line of the output. Each line should contain both the input and the output of a single computation, with the format specified in the appropriate section of the schema definition. 

The columns corresponding to input are the same as the primary and secondary input columns in the computations file. The columns corresponding to ouput are specified by a section of the schema file of the form 

	columns <ncolumns> {
		output <outputcolumn>
		[replacement {
				match <toreplace>
				with <replacestring>
			}
		...
		]
		...
	}

Replacement rules are optional and they only affect the behaviour of `yggdrasill`.

As an example, consider the following schema:

	columns 6 {
		output 4
	}

	inputcolumns 1 {
		rangeinputcolumn 2
		textinputcolumn 3
	}

This schema declares that each row of the work script output contains 6 columns. Columns 5 and 6 represent computation output; columns 1,2,3 the input; columns 4 and 7 are ignored. Column 1 is an integer, which represents the primary input to the computation; columns 2 and 3 are treated as arbitrary text. A compatible work script could take the following form:

	file:=Open(dataFile,"r");
	line:=Gets(file);
	while not IsEof(line) do
		primaryInput1,secondaryInput1,secondaryInput2:=ReadLine(line);
		output, time, memory:=Compute(primaryInput1,secondaryInput1,secondaryInput2);	//invoke a function that performs the actual computation
		WriteFields(primaryInput1,secondaryInput1,secondaryInput2,output,time,memory);
		line:=Gets(file);
	end while;

See `example/magma/workscript.m` for a complete example.

## How it works

The computation is run in parallel, by distributing the computations to be done among different Magma processes. Each process is instructed to run with a given memory limit, and possibly with a time limit; if Magma terminates before finishing (because time or memory run out), `hliðskjálf` tries to assign the offending computation to a process with a higher memory limit as soon as one becomes available. The distribution of memory among processes is changed automatically as computations progress. Computations which cannot be completed even by increasing the memory limit are skipped, and their input values stored into a *valhalla* file. `hliðskjálf` ensures that computations are not repeated by reading the files in the work script output directory, and eliminating the corresponding computations. 

The behaviour of `hliðskjálf` is affected by a number of command-line options.

Options controlling output:

By default, `hliðskjálf` operates in interactive mode. Alternative behavious can be chosen as follows:
- `--stdio` 	print out progress to standard output
- `--batch-mode`   print out a list of computations to do, without launching any actual calculation

Path options:

- `--script <workscript>` <br> 	work script filename
- `--workoutput <workoutput>`<br>output directory of work script (defaults to the stem of `<computations_file>`)
- `--extension <workextension> (=.work)` <br> extension of files generated by the work script
- `--computations <computations_file>` <br>input file containing the list of computations
- `--schema <schema_file>`             <br>info file defining the CSV schema
- `--valhalla <valhalla_file>`           <br>file where unterminated computations are to be stored (defaults to `<workoutput>.valhalla`)

Options controlling the work script:

- `--flags <flags>`<br>additional flags to be passed to the work script

Options affecting the general behaviour of `hliðskjálf`:

- `--db <path_to_db>`               <br>if set, computations listed in the database are skipped. The argument indicates the  directory containing the database of already performed computations.
- `--nthreads <nthreads> (=10)`     <br>number of worker threads and magma processes to be run
- `--workload <workload> (=100)`    <br>number of computations to be performed by each process. If computations are extremely fast, increasing this number may reduce the overhead of launching new processes.
- `--free-memory <gigabytes> (=0)`   <br>if set, quit all computations when system free memory goes below this threshold in GB. Only works on Linux.
- `--total-memory <gigabytes> (=4)`  <br>total memory limit in GB for all threads
- `--memory <megabytes> (=128)`      <br>base memory limit in MB for each thread
- `--base-timeout <seconds> (=0)`  <br>assign a time limit to each process. The argument is the base timeout limit in seconds. This limit is increased alongside with the memory limit, proportionally, when computations are repeated.


## The database

The output of `hliðskjálf` is a sequence of `.work` files in the `workoutput` directory, which contain the results of the computations in an unspecified order. Reading through this output to look for a specific computation can be quite slow. The tool `yggdrasill` was designed to increase the speed of these queries by reformatting the output in the form of a database.

Using the database also has a positive impact on performance in case of repeated runs of `hliðskjálf`. Indeed, if `hliðskjálf` is interrupted, a subsequent run with the same `workoutput` will skip the computations already performed. This means that each run of `hliðskjálf` must iterate through all computations performed to eliminate them. This can be quite slow for large sets of computations. If the computations are stored in a database, they can be eliminated with the command-line option `--db`, which is considerably faster.


### Running `yggdrasill`

In order to create a database or update an existing one, invoke `yggdrasill`  as

	yggdrasill --workoutput <workoutput> --db <path_to_db> --schema <schema_file>

This command adds every computation in the directory `<workoutput>` to the database in the directory `<path_to_db>`; the schema file `<schema_file>` indicates how the work script output should be interpreted.

The current implementation of the database is just a sequence of CSV files, with name parametrized by the primary input column. Each row contains the secondary input and the output. The database can then be read by a Magma script, see `examples/readfromdb.m` for an example.

The behaviour of `yggdrasill` can be modified by indicating *replacement rules* and *omit rules* in the schema file.

### Replacement rules
Output column specification may contain replacement rules, as in 

	columns 7 {
		output 5
		replacement {
			match Odin
			with Alfaðir
		}
	}

This has the effect of replacing every occurrence of Odin in column 5 with Alfaðir, when `yggdrasill` reads work script output to update the database. To define more than one replacement rule, use curly braces, as in 

	columns 7 {
		output 5 {
			replacement {
				match gold
				with Sifjar haddr
			}
			replacement {
				match sky
				with Ymis haus
			}
		}			
	}

### Omit rules
The schema file can also contain patterns of the form:

	omitrules {
		condition {
			column 6
			contains Huginn
		}
		condition {
			column 5
			match Muninn	
		}
	}

The effect of this declaration is to ignore, when `yggdrasill` reads work script output, every row such that either column 6 contains the string Huginn or column 5 matches exactly the string Muninn. The corresponding entries will not be inserted into the database.


